- pipeline: "test"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "*"
  ref_type: "WILDCARD"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: composer install"
    type: "BUILD"
    working_directory: "/buddy/php-workshop"
    docker_image_name: "library/php"
    docker_image_tag: "7.2-stretch"
    execute_commands:
    - "composer install"
    - "composer tests-full"
    setup_commands:
    - "apt-get update && apt-get install -y git zip"
    - "curl -L https://phar.phpunit.de/phpunit.phar -o /usr/local/bin/phpunit"
    - "chmod +x /usr/local/bin/phpunit"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "# php ext gd"
    - "apt-get install -y libfreetype6-dev"
    - "apt-get install -y libjpeg62-turbo-dev"
    - "apt-get install -y libpng-dev"
    - "docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/"
    - "docker-php-ext-install gd"
    - "# php ext zip"
    - "apt-get install -y zip"
    - "apt-get install -y unzip"
    - "apt-get install -y zlib1g-dev"
    - "docker-php-ext-install zip"
    - "# php ext pdo_mysql"
    - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
    - "docker-php-ext-install pdo_mysql"
    - ""
    - "# php ext pdo_pgsql"
    - "apt-get install -y libpq-dev"
    - "docker-php-ext-configure pdo_pgsql --with-pdo-pgsql"
    - "docker-php-ext-install pdo_pgsql"
    services:
    - type: "POSTGRE_SQL"
      version: "9.5.3"
      connection:
        host: "postgres"
        port: 5432
        user: "root"
        password: "root"
        db: "todohub_test"
    mount_filesystem_path: "/buddy/php-workshop"
    shell: "BASH"
    trigger_condition: "ALWAYS"
  - action: "Run php-workshop/deploy to prod"
    type: "RUN_NEXT_PIPELINE"
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    revision: "HEAD"
    trigger_condition: "ALWAYS"
    next_project_name: "php-workshop"
    next_pipeline_name: "deploy to prod"
  variables:
  - key: "DATABASE_URL"
    value: "postgresql://root:root@postgres:5432/todohub"
    id: 243905
    description: ""
- pipeline: "deploy to prod"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Upload files to ec2-35-159-53-118.eu-central-1.compute.amazonaws.com"
    type: "SFTP"
    input_type: "SCM_REPOSITORY"
    remote_path: "/var/www/app/deploy-cache"
    login: "${ssh_username}"
    host: "ec2-35-159-53-118.eu-central-1.compute.amazonaws.com"
    port: "22"
    server_key: "secure!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"
    authentication_mode: "PRIVATE_KEY"
  - action: "Post-deployment action"
    type: "SSH_COMMAND"
    working_directory: "/var/www/app"
    login: "${ssh_username}"
    host: "ec2-35-159-53-118.eu-central-1.compute.amazonaws.com"
    port: "22"
    server_key: "secure!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"
    authentication_mode: "PRIVATE_KEY"
    commands:
    - "if [ -d \"releases/$BUDDY_EXECUTION_REVISION\" ] && [ \"$BUDDY_EXECUTION_REFRESH\" = \"true\" ];"
    - "then"
    - " echo \"Removing: releases/$BUDDY_EXECUTION_REVISION\""
    - " rm -rf releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - "if [ ! -d \"releases/$BUDDY_EXECUTION_REVISION\" ];"
    - "then"
    - " echo \"Creating: releases/$BUDDY_EXECUTION_REVISION\""
    - " cp -dR deploy-cache releases/$BUDDY_EXECUTION_REVISION;"
    - "fi"
    - "echo \"Build Symfony Application\""
    - "cd releases/$BUDDY_EXECUTION_REVISION"
    - "echo \"APP_ENV=prod\" > .env.local"
    - "echo \"DATABASE_URL=$DATABASE_URL\" >> .env.local"
    - "composer install --no-dev --optimize-autoloader"
    - "php bin/console d:m:m --no-interaction"
    - "cd ../.."
    - "echo \"Linking current to revision: $BUDDY_EXECUTION_REVISION\""
    - "rm -f current"
    - "ln -s releases/$BUDDY_EXECUTION_REVISION current"
    - "echo \"Removing old releases\""
    - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
  variables:
  - key: "ssh_username"
    value: "ubuntu"
    id: 243931
